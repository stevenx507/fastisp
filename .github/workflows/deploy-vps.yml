name: Deploy VPS

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Entorno objetivo"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging
      migrate_db:
        description: "Ejecutar migraciones DB"
        required: true
        default: true
        type: boolean
      rebuild_services:
        description: "Rebuild backend/frontend"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}-${{ inputs.target }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.target }}
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |
            set -e
            export APP_DIR="${{ secrets.VPS_APP_DIR }}"
            if [ -z "$APP_DIR" ]; then APP_DIR="$HOME/fastisp"; fi
            cd "$APP_DIR"
            git fetch origin main
            git checkout main
            git pull origin main

            if [ "${{ inputs.rebuild_services }}" = "true" ]; then
              docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --build backend frontend
            else
              docker compose --env-file .env.prod -f docker-compose.prod.yml up -d backend frontend
            fi

            if [ "${{ inputs.migrate_db }}" = "true" ]; then
              docker compose --env-file .env.prod -f docker-compose.prod.yml exec -T backend python -m flask --app wsgi.py db upgrade
            fi

            docker compose --env-file .env.prod -f docker-compose.prod.yml ps
            docker compose --env-file .env.prod -f docker-compose.prod.yml logs --tail=50 backend
