services:
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=ispmax
      - POSTGRES_USER=ispmax
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - ispmax-network

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD is required}"]
    networks:
      - ispmax-network

  backend:
    build:
      context: ./backend
      target: production
    env_file:
      - .env.prod
    environment:
      - CACHE_TYPE=SimpleCache
      - CACHE_REDIS_URL=
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - ALLOW_INSECURE_GOOGLE_LOGIN=${ALLOW_INSECURE_GOOGLE_LOGIN:-false}
    command: ["/bin/sh","-c","CACHE_TYPE=SimpleCache CACHE_REDIS_URL= gunicorn --bind 0.0.0.0:5000 --workers 2 wsgi:app"]
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - backups:/app/backups
    networks:
      - ispmax-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${API_HOST:-api.fastisp.cloud}`)"
      - "traefik.http.routers.api.entrypoints=web,websecure"
      - "traefik.http.routers.api.tls.certresolver=myresolver"
      - "traefik.http.routers.api.priority=120"
      - "traefik.http.routers.api.middlewares=secure-headers@docker,ipwhitelist@docker,geoip2@file"
      - "traefik.http.services.api.loadbalancer.server.port=5000"


  frontend:
    build:
      context: ./frontend
      target: production
      args:
        - VITE_API_URL=${API_URL}
        - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
        - VITE_GRAFANA_URL=${VITE_GRAFANA_URL}
    env_file:
      - .env.prod
    environment:
      - VITE_API_URL=${API_URL}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
    networks:
      - ispmax-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_HOST:-fastisp.cloud}`)"
      - "traefik.http.routers.frontend.entrypoints=web,websecure"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      - "traefik.http.routers.frontend.priority=100"
      - "traefik.http.routers.frontend.middlewares=secure-headers@docker,ipwhitelist@docker,geoip2@file"
      - "traefik.http.routers.frontend-tenants.rule=HostRegexp(`{tenant:[a-z0-9-]+}.${TENANCY_ROOT_DOMAIN:-fastisp.cloud}`)"
      - "traefik.http.routers.frontend-tenants.entrypoints=web,websecure"
      - "traefik.http.routers.frontend-tenants.tls.certresolver=myresolver"
      - "traefik.http.routers.frontend-tenants.priority=10"
      - "traefik.http.routers.frontend-tenants.middlewares=secure-headers@docker,ipwhitelist@docker,geoip2@file"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

  celery-worker:
    build:
      context: ./backend
      target: production
    env_file:
      - .env.prod
    environment:
      - CACHE_TYPE=SimpleCache
      - CACHE_REDIS_URL=
    command: ["celery", "-A", "app.tasks", "worker", "--loglevel=info", "--concurrency=2"]
    depends_on:
      - backend
      - redis
      - postgres
    networks:
      - ispmax-network

  celery-beat:
    build:
      context: ./backend
      target: production
    env_file:
      - .env.prod
    environment:
      - CACHE_TYPE=SimpleCache
      - CACHE_REDIS_URL=
    command: ["celery", "-A", "app.tasks", "beat", "--loglevel=info"]
    depends_on:
      - backend
      - redis
      - postgres
    networks:
      - ispmax-network

  traefik:
    image: traefik:v2.10
    command:
      - --api.insecure=false
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=ispmax-network
      - --providers.file.directory=/etc/traefik/dynamic
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.myresolver.acme.httpchallenge=true
      - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.myresolver.acme.email=${TRAEFIK_ACME_EMAIL}
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
      - --entrypoints.websecure.forwardedheaders.insecure=true
      - --serverstransport.insecureskipverify=true
      - --experimental.plugins.geoip2.modulename=github.com/traefik/plugin-geoip2
      - --experimental.plugins.geoip2.version=v0.6.0
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
      - ./deploy/traefik:/etc/traefik/dynamic:ro
      - ./deploy/geoip:/geoip:ro
    networks:
      - ispmax-network
    labels:
      - "traefik.http.middlewares.secure-headers.headers.framedeny=true"
      - "traefik.http.middlewares.secure-headers.headers.contenttypeNosniff=true"
      - "traefik.http.middlewares.secure-headers.headers.referrerPolicy=no-referrer-when-downgrade"
      - "traefik.http.middlewares.secure-headers.headers.stsSeconds=63072000"
      - "traefik.http.middlewares.secure-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.secure-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.ipwhitelist.ipwhitelist.sourcerange=${WAF_IP_ALLOWLIST:?WAF_IP_ALLOWLIST is required}"
      - "traefik.http.middlewares.geoip2.plugin.geoip2.databasePath=/geoip/GeoLite2-Country.mmdb"
      - "traefik.http.middlewares.geoip2.plugin.geoip2.header=X-Country-Code"

volumes:
  pgdata:
  backups:
  letsencrypt:

networks:
  ispmax-network:
    driver: bridge
